<app-page-header title="ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹" />

<div class="card" style="max-width:560px">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- Part Search -->
    <div class="form-group">
      <label class="form-label">Ø§Ù„Ù‚Ø·Ø¹Ø© <span class="required">*</span></label>

      @if (selectedPart()) {
        <!-- Selected part chip -->
        <div class="selected-part-chip">
          <div class="selected-part-info">
            <span class="selected-part-name">{{ selectedPart()!.name }}</span>
            <span class="selected-part-meta">
              Ù…ØªØ§Ø­: {{ selectedPart()!.quantity }} &nbsp;|&nbsp; {{ selectedPart()!.price | number:'1.2-2' }} Ø¬.Ù…
            </span>
          </div>
          <button type="button" class="btn-clear-part" (click)="clearPart()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø·Ø¹Ø©">âœ•</button>
        </div>
      } @else {
        <!-- Search input with dropdown -->
        <div class="autocomplete-wrapper">
          <div class="autocomplete-input-wrap">
            <span class="autocomplete-icon">ğŸ”</span>
            <input
              #searchInput
              class="form-control autocomplete-input"
              [class.is-invalid]="form.controls.sparePartId.invalid && form.controls.sparePartId.touched"
              [formControl]="searchControl"
              (focus)="onSearchFocus()"
              (blur)="onSearchBlur()"
              type="text"
              placeholder="Ø§Ø¶ØºØ· Ù„Ù„ØªØµÙØ­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..."
              autocomplete="off"
            />
            @if (searching()) {
              <span class="autocomplete-spinner"></span>
            }
          </div>

          @if (showDropdown()) {
            <div class="autocomplete-dropdown">
              @for (part of searchResults(); track part._id) {
                <div class="autocomplete-item" (mousedown)="selectPart(part)">
                  <span class="autocomplete-item-name">{{ part.name }}</span>
                  <div class="autocomplete-item-meta">
                    <span class="badge badge-info">Ù…ØªØ§Ø­: {{ part.quantity }}</span>
                    <span class="badge badge-success">{{ part.price | number:'1.2-2' }} Ø¬.Ù…</span>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        @if (form.controls.sparePartId.invalid && form.controls.sparePartId.touched) {
          <p class="form-error">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø·Ø¹Ø©</p>
        }
      }
    </div>

    <!-- Quantity -->
    <div class="form-group">
      <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© <span class="required">*</span></label>
      <input
        class="form-control"
        [class.is-invalid]="form.controls.quantitySold.invalid && form.controls.quantitySold.touched"
        type="number"
        formControlName="quantitySold"
        min="1"
        placeholder="1"
      />
      @if (form.controls.quantitySold.invalid && form.controls.quantitySold.touched) {
        <p class="form-error">Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
      }
    </div>

    <!-- Total preview -->
    @if (expectedTotal > 0) {
      <div class="total-preview">
        <span class="text-muted text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span>
        <strong class="total-amount">{{ expectedTotal | number:'1.2-2' }} Ø¬.Ù…</strong>
      </div>
    }

    <div class="flex gap-2">
      <button type="submit" class="btn btn-primary" [disabled]="loading() || !selectedPart()">
        @if (loading()) { Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸... } @else { ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ }
      </button>
      <button type="button" class="btn btn-ghost" (click)="goBack()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

  </form>
</div>
